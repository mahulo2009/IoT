version: "3.5"
services:

  # gcs
  gcs:
    image: mhuertas/instalacionconectada:gcs 
    hostname: gcs
    container_name: gcs
    depends_on:
      - db    
    networks:
      - default
      
  # Database
  db:
    image: mhuertas/instalacionconectada:mysql 
    hostname: db
    container_name: db
    networks:
      - default   
    ports:
       - 3306:3306
    volumes:
      - data:/var/lib/mysql     
    environment:
      - MYSQL_ROOT_PASSWORD=passroot

  # Orion is the context broker
  orion:
    image: mhuertas/instalacionconectada:orion 
    hostname: orion
    container_name: orion
    depends_on:
      - mongo-db
    networks:
      - default
    ports:
      - "${ORION_PORT}:${ORION_PORT}" # localhost:1026
    command: -dbhost mongo -logLevel DEBUG -noCache
    healthcheck:
      test: curl --fail -s http://orion:${ORION_PORT}/version || exit 1
      interval: 5s

  # Databases
  mongo-db:
    image: mhuertas/instalacionconectada:mongo 
    hostname: mongo
    container_name: mongo
    expose:
      - "${MONGO_DB_PORT}"
    ports:
      - "${MONGO_DB_PORT}:${MONGO_DB_PORT}" # localhost:27017 # localhost:27017
    networks:
      - default
    volumes:
      - mongo-db:/data
    healthcheck:
      test: |
        host=`hostname --ip-address || echo '127.0.0.1'`; 
        mongo --quiet $host/test --eval 'quit(db.runCommand({ ping: 1 }).ok ? 0 : 2)' && echo 0 || echo 1
      interval: 5s
      
  mosquitto:
    image: mhuertas/instalacionconectada:mosquitto 
    hostname: mosquitto
    container_name: mosquitto
    expose:
      - "1883"
      - "9001"
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - default      

  # Databases
  iot-agent:
    image: mhuertas/instalacionconectada:iot-agent 
    hostname: iot-agent
    container_name: iot-agent
    depends_on:
      - mongo-db
    networks:
      - default 
    expose:
      - "${IOTA_NORTH_PORT}"
      - "${IOTA_SOUTH_PORT}"     
    ports:
      - "${IOTA_NORTH_PORT}:${IOTA_NORTH_PORT}" # localhost:4041
      - "${IOTA_SOUTH_PORT}:${IOTA_SOUTH_PORT}" # localhost:7896
    environment:
      - IOTA_CB_HOST=orion # name of the context broker to update context
      - IOTA_CB_PORT=${ORION_PORT} # port the context broker listens on to update context
      - IOTA_NORTH_PORT=${IOTA_NORTH_PORT}
      - IOTA_REGISTRY_TYPE=mongodb #Whether to hold IoT device info in memory or in a database
      - IOTA_LOG_LEVEL=DEBUG # The log level of the IoT Agent
      - IOTA_TIMESTAMP=true # Supply timestamp information with each measurement
      - IOTA_CB_NGSI_VERSION=v2 # use NGSIv2 when sending updates for active attributes
      - IOTA_AUTOCAST=true # Ensure Ultralight number values are read as numbers not strings
      - IOTA_MONGO_HOST=mongo-db # The host name of MongoDB
      - IOTA_MONGO_PORT=${MONGO_DB_PORT} # The port mongoDB is listening on
      - IOTA_MONGO_DB=iotagentul # The name of the database used in mongoDB
      - IOTA_HTTP_PORT=${IOTA_SOUTH_PORT} # The port used for device traffic over HTTP
      - IOTA_PROVIDER_URL=http://iot-agent:${IOTA_NORTH_PORT}
      - IOTA_MQTT_HOST=mosquitto
      - IOTA_MQTT_PORT=1883      
      - IOTA_DEFAULT_RESOURCE=/iot/d      
    healthcheck:
      interval: 5s   

  quantumleap:
    image: mhuertas/instalacionconectada:quantumleap
    ports:
      - "8668:8668"
    depends_on:
      - mongo-db
      - orion
      - crate
    environment:
      - CRATE_HOST=crate

  crate:
    image: mhuertas/instalacionconectada:crate
    hostname: crate
    ports:
      # Admin UI
      - "4200:4200"
      # Transport protocol
      - "4300:4300"
    command: 
        crate -Cauth.host_based.enabled=false -Ccluster.name=democluster -Chttp.cors.enabled=true -Chttp.cors.allow-origin="*"
    environment:
        - CRATE_HEAP_SIZE=2g        
    volumes:
      - cratedata:/data

  grafana:
    image: mhuertas/instalacionconectada:grafana
    ports:
      - "3000:3000"
    environment:
      -  plugins="crate-datasource,grafana-clock-panel,grafana-worldmap-panel"
    depends_on:
      - crate        

networks:
  default:
    ipam:
      config:
        - subnet: 172.18.1.0/24

volumes:
  mongo-db: 
  cratedata:
  redisdata:
  data:  
  
  
 #todo db environemt variable in gcs point to db 
 #todo install vim in gcs
 #todo monitormanager scheme no se crea bien. (simplificar schemene para quitar particione en docker)
 #todo el cs podria ser sin scidb?
 #todo crate sysctl -w vm.max_map_count=262144
 #todo grafana plugin (working)
 #todo volume for grafana (not loosing cofiguration)
 #todo use curlcpp para crear todo lo necesario (servicioes...)
